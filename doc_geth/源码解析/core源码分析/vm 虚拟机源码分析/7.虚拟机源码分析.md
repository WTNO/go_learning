# core-vm源码分析
## contract.go
contract 代表了以太坊 state database里面的一个合约。包含了合约代码，调用参数。

### 数据结构
```go
// ContractRef是对合约后备对象的引用
type ContractRef interface {
	Address() common.Address
}

// AccountRef实现了ContractRef。
//
// 在EVM初始化期间使用账户引用，其主要用途是获取地址。由于缓存的跳转目标是从父合约（即调用者）获取的，因此删除此对象会变得困难。
type AccountRef common.Address

// Address将AccountRef转换为Address
func (ar AccountRef) Address() common.Address { return (common.Address)(ar) }

// Contract表示状态数据库中的以太坊合约。它包含合约代码和调用参数。Contract实现了ContractRef接口。
type Contract struct {
	// CallerAddress是初始化该合约的调用者的结果。但是，当“调用方法”被委派时，该值需要被初始化为调用者的调用者的值。
	CallerAddress common.Address
	caller        ContractRef
	self          ContractRef

	jumpdests map[common.Hash]bitvec // JUMPDEST分析的聚合结果。
	analysis  bitvec                 // JUMPDEST分析的本地缓存结果

	Code     []byte
	CodeHash common.Hash
	CodeAddr *common.Address
	Input    []byte

	Gas   uint64
	value *big.Int
}
```

### 构造函数
```go
// NewContract函数返回一个用于执行EVM的新合约环境。
func NewContract(caller ContractRef, object ContractRef, value *big.Int, gas uint64) *Contract {
	c := &Contract{CallerAddress: caller.Address(), caller: caller, self: object}

	if parent, ok := caller.(*Contract); ok {
		// 如果父上下文中有可用的JUMPDEST分析结果，则重用
		c.jumpdests = parent.jumpdests
	} else {
		c.jumpdests = make(map[common.Hash]bitvec)
	}

	// Gas应该是一个指针，这样可以通过运行来安全地减少
	// 这个指针将在状态转换中关闭
	c.Gas = gas
	// 确保设置了value
	c.value = value

	return c
}
```

### AsDelegate
将合约设置为委托调用并返回当前合同（用于链式调用）
```go
// AsDelegate函数将合约设置为委托调用，并返回当前合约（用于链式调用）。
func (c *Contract) AsDelegate() *Contract {
    // 注意：调用者必须始终是一个合约。调用者绝不应该是除合约之外的其他东西。
    parent := c.caller.(*Contract)
    c.CallerAddress = parent.CallerAddress
    c.value = parent.value

    return c
}
```

### GetOp
用来获取下一跳指令
```go
// GetOp函数返回合约字节数组中的第n个元素。
func (c *Contract) GetOp(n uint64) OpCode {
	if n < uint64(len(c.Code)) {
		return OpCode(c.Code[n])
	}

	return STOP
}
```

### UseGas
使用Gas
```go
// UseGas函数尝试使用燃料，并在成功时减去相应数量的燃料，并返回true
func (c *Contract) UseGas(gas uint64) (ok bool) {
	if c.Gas < gas {
		return false
	}
	c.Gas -= gas
	return true
}
```








































