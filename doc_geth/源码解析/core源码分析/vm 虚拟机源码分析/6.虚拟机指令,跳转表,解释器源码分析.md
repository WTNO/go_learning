# core/vm/jumptable + instruction

## jumptable
jumptable. 是一个 [256]operation 的数据结构. 每个下标对应了一种指令, 使用operation来存储了指令对应的处理逻辑, gas消耗, 堆栈验证方法, memory使用的大小等功能.

### 数据结构
operation存储了一条指令的所需要的函数.
```go
type operation struct {
	// execute 是操作函数
	execute     executionFunc
	// constantGas 是操作的固定消耗的 gas 数量
	constantGas uint64
	// dynamicGas 是操作的动态消耗的 gas 数量
	dynamicGas  gasFunc
	// minStack 表示操作所需的最小堆栈项数
	minStack int
	// maxStack 指定堆栈在此操作中允许的最大长度，以避免堆栈溢出。
	maxStack int

	// memorySize 返回操作所需的内存大小
	memorySize memorySizeFunc
}
```

### 指令集
下面定义了三种指令集,针对三种不同的以太坊版本,
```go
var ( 
	frontierInstructionSet = NewFrontierInstructionSet()
	homesteadInstructionSet = NewHomesteadInstructionSet()
	byzantiumInstructionSet = NewByzantiumInstructionSet()
) 
```


NewByzantiumInstructionSet：拜占庭版本，首先调用`newSpuriousDragonInstructionSet`创造了前一个版本的指令，然后增加自己特有的指令：`STATICCALL`, `RETURNDATASIZE`, `RETURNDATACOPY`, `REVERT`。
```go
// newByzantiumInstructionSet返回前沿、家园和拜占庭指令。
func newByzantiumInstructionSet() JumpTable {
	instructionSet := newSpuriousDragonInstructionSet()
	instructionSet[STATICCALL] = &operation{
		execute:     opStaticCall,
		constantGas: params.CallGasEIP150,
		dynamicGas:  gasStaticCall,
		minStack:    minStack(6, 1),
		maxStack:    maxStack(6, 1),
		memorySize:  memoryStaticCall,
	}
	instructionSet[RETURNDATASIZE] = &operation{
		execute:     opReturnDataSize,
		constantGas: GasQuickStep,
		minStack:    minStack(0, 1),
		maxStack:    maxStack(0, 1),
	}
	instructionSet[RETURNDATACOPY] = &operation{
		execute:     opReturnDataCopy,
		constantGas: GasFastestStep,
		dynamicGas:  gasReturnDataCopy,
		minStack:    minStack(3, 0),
		maxStack:    maxStack(3, 0),
		memorySize:  memoryReturnDataCopy,
	}
	instructionSet[REVERT] = &operation{
		execute:    opRevert,
		dynamicGas: gasRevert,
		minStack:   minStack(2, 0),
		maxStack:   maxStack(2, 0),
		memorySize: memoryRevert,
	}
	return validate(instructionSet)
}
```

NewHomesteadInstructionSet
```go
// newHomesteadInstructionSet返回在家园阶段可以执行的前沿和家园指令。
func newHomesteadInstructionSet() JumpTable {
	instructionSet := newFrontierInstructionSet()
	instructionSet[DELEGATECALL] = &operation{
		execute:     opDelegateCall,
		dynamicGas:  gasDelegateCall,
		constantGas: params.CallGasFrontier,
		minStack:    minStack(6, 1),
		maxStack:    maxStack(6, 1),
		memorySize:  memoryDelegateCall,
	}
	return validate(instructionSet)
}
```

NewFrontierInstructionSet：返回在前沿阶段可以执行的前沿指令。






























