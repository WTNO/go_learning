# 以太坊的trie树管理 回滚等操作 state源码分析
`core/state` 包主要为以太坊的state trie提供了一层缓存层(cache)

state的结构主要如下图

<img src="../../img/state_1.png">

蓝色的矩形代表本模块， 灰色的矩形代表外部模块。
- database主要提供了trie树的抽象，提供trie树的缓存和合约代码长度的缓存。
- journal主要提供了操作日志，以及操作回滚的功能。
- state_object是account对象的抽象，提供了账户的一些功能。
- statedb主要是提供了state trie的部分功能。

## database.go
database.go 提供了一个数据库的抽象。

### 数据结构
```go
// Database接口封装了对trie和合约代码的访问。
type Database interface {
	// OpenTrie打开主账户trie。
	OpenTrie(root common.Hash) (Trie, error)

	// OpenStorageTrie打开账户的存储trie。
	OpenStorageTrie(stateRoot common.Hash, addrHash, root common.Hash) (Trie, error)

	// CopyTrie返回给定trie的独立副本。
	CopyTrie(Trie) Trie

	// ContractCode检索特定合约的代码。
	ContractCode(addrHash, codeHash common.Hash) ([]byte, error)

	// ContractCodeSize检索特定合约代码的大小。
	ContractCodeSize(addrHash, codeHash common.Hash) (int, error)

	// DiskDB返回底层的键值对磁盘数据库。
	DiskDB() ethdb.KeyValueStore

	// TrieDB检索用于数据存储的底层trie数据库。
	TrieDB() *trie.Database
}

// NewDatabase函数创建一个用于存储状态的后端存储。
// 返回的数据库可以安全地进行并发使用，但不会在内存中保留任何最近的Trie节点。
// 要在内存中保留一些历史状态，请使用NewDatabaseWithConfig构造函数。
func NewDatabase(db ethdb.Database) Database {
    return NewDatabaseWithConfig(db, nil)
}

type cachingDB struct {
    disk          ethdb.KeyValueStore
    codeSizeCache *lru.Cache[common.Hash, int]
    codeCache     *lru.SizeConstrainedCache[common.Hash, []byte]
    triedb        *trie.Database
}
```

### OpenTrie
从缓存里面查找。如果找到了返回缓存的trie的copy， 否则重新构建一颗树返回。
```go
// OpenTrie函数用于打开指定根哈希的主账户Trie。
func (db *cachingDB) OpenTrie(root common.Hash) (Trie, error) {
	tr, err := trie.NewStateTrie(trie.StateTrieID(root), db.triedb)
	if err != nil {
		return nil, err
	}
	return tr, nil
}


// NewStateTrie函数从一个后备数据库中创建一个带有现有根节点的trie。
// 
// 如果根节点是零哈希或空字符串的sha3哈希，则trie最初为空。
// 否则，如果db为nil，New将会抛出panic，并且如果找不到根节点，则返回MissingNodeError。
func NewStateTrie(id *ID, db *Database) (*StateTrie, error) {
    if db == nil {
        panic("trie.NewStateTrie called without a database")
    }
    trie, err := New(id, db)
    if err != nil {
        return nil, err
    }
    return &StateTrie{trie: *trie, preimages: db.preimages}, nil
}

// OpenStorageTrie函数打开一个账户的存储trie
func (db *cachingDB) OpenStorageTrie(stateRoot common.Hash, addrHash, root common.Hash) (Trie, error) {
    tr, err := trie.NewStateTrie(trie.StorageTrieID(stateRoot, addrHash, root), db.triedb)
    if err != nil {
        return nil, err
    }
    return tr, nil
}
```



































