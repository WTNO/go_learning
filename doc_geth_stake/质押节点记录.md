## 运行环境/工具
### 运行环境
阿里云ECS服务器，配置如下
1. 4核(vCPU) 16 GiB
2. Ubuntu  20.04 64位
3. 系统盘1400G
4. 带宽 8Mbps

开通时长一周，花费386.49元

### 使用工具
- 执行客户端：Geth
- 信标客户端：Prysm
- 远程连接：XShell

## 步骤 1：连接到服务器
```shell
adduser wtno
usermod -aG sudo wtno
rsync --archive --chown=wtno:wtno ~/.ssh /home/wtno
```
<img src="./img/质押记录1.PNG">

## 步骤 2：更新服务器
```shell
sudo apt -y update && sudo apt -y upgrade
```

<img src="./img/质押记录2.PNG">

<img src="./img/质押记录3.PNG">

```shell
sudo apt dist-upgrade && sudo apt autoremove
```

<img src="./img/质押记录4.PNG">

重启
```shell
sudo reboot
```

## 步骤3：保护服务器
### 修改默认的SSH端口
跳过

### 配置防火墙
```shell
$ sudo apt install ufw
$ sudo ufw default deny incoming
$ sudo ufw default allow outgoing
$ sudo ufw allow 22/tcp
$ sudo ufw allow 30303
$ sudo ufw allow 13000/tcp
$ sudo ufw allow 12000/udp
$ sudo ufw allow 3000/tcp
$ sudo ufw enable
$ sudo ufw status numbered
```

<img src="./img/质押记录5.PNG">


## 步骤4：创建交换空间
```shell
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

sudo cp /etc/fstab /etc/fstab.bak
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

sudo sysctl vm.swappiness=10
sudo sysctl vm.vfs_cache_pressure=50

sudo nano /etc/sysctl.conf
```

在文件末尾添加
```shell
vm.swappiness=10
vm.vfs_cache_pressure = 50
```

<img src="./img/创建交换空间.PNG">

## 步骤5：配置时间同步
```shell
timedatectl #验证它是否正常运行。
```
<img src="./img/质押记录6.PNG">

## 步骤6：生成客户端身份验证密钥
```shell
$ sudo mkdir -p /var/lib/jwtsecret
$ openssl rand -hex 32 | sudo tee /var/lib/jwtsecret/jwt.hex > /dev/null
$ sudo nano /var/lib/jwtsecret/jwt.hex #然后按 CTRL + X 退出
```

<img src="./img/质押记录7.PNG">

## 步骤7：配置执行客户端Geth
```shell
cd ~
curl -LO https://gethstore.blob.core.windows.net/builds/geth-linux-amd64-1.12.0-e501b3b0.tar.gz

tar xvf geth-linux-amd64-1.12.0-e501b3b0.tar.gz
cd geth-linux-amd64-1.12.0-e501b3b0
sudo cp geth /usr/local/bin

cd ~
rm geth-linux-amd64-1.12.0-e501b3b0.tar.gz
rm -r geth-linux-amd64-1.12.0-e501b3b0

sudo useradd --no-create-home --shell /bin/false geth

sudo mkdir -p /var/lib/geth

sudo chown -R geth:geth /var/lib/geth

sudo nano /etc/systemd/system/geth.service
```

粘贴到文件中
```shell
[Unit]
Description=Geth Execution Client (Goerli Test Network)
After=network.target
Wants=network.target
[Service]
User=geth
Group=geth
Type=simple
Restart=always
RestartSec=5
TimeoutStopSec=600
ExecStart=/usr/local/bin/geth \
  --goerli \
  --datadir /var/lib/geth \
  --authrpc.jwtsecret /var/lib/jwtsecret/jwt.hex \
  --metrics \
  --metrics.addr 127.0.0.1
[Install]
WantedBy=default.target
```

保存后退出，继续执行
```shell
$ sudo systemctl daemon-reload
$ sudo systemctl start geth
$ sudo systemctl status geth
```

<img src="./img/质押记录8.PNG">

开始同步
```shell
sudo journalctl -fu geth

sudo systemctl enable geth #启用geth服务以在重新启动时自动启动。
```

<img src="./img/质押记录9.PNG">

TODO:还是找不到对等节点

## 步骤8：安装Prysm共识客户端
```shell
cd ~
curl -LO https://github.com/prysmaticlabs/prysm/releases/download/v4.0.7/beacon-chain-v4.0.7-linux-amd64
curl -LO https://github.com/prysmaticlabs/prysm/releases/download/v4.0.7/validator-v4.0.7-linux-amd64

mv beacon-chain-v4.0.7-linux-amd64 beacon-chain
mv validator-v4.0.7-linux-amd64 validator
chmod +x beacon-chain
chmod +x validator
sudo cp beacon-chain /usr/local/bin
sudo cp validator /usr/local/bin

rm beacon-chain && rm validator
```

<img src="./img/安装Prysm共识客户端.png">

## 步骤9：生成质押数据
```shell
#下载存款工具
cd ~
curl -LO https://github.com/ethereum/staking-deposit-cli/releases/download/v2.3.0/staking_deposit-cli-76ed782-linux-amd64.tar.gz

tar xvf staking_deposit-cli-76ed782-linux-amd64.tar.gz
cd staking_deposit-cli-76ed782-linux-amd64
```

运行存款工具
```shell
./deposit new-mnemonic --num_validators 2 --chain goerli --eth1_withdrawal_address 0x4D496CcC28058B1D74B7a19541663E21154f9c84
```

然后按照教程生成助记词和密钥

<img src="./img/生成助记词.png">

<img src="./img/密钥创建.png">

## 步骤10：导入验证者密钥
```shell
# 将验证器密钥库文件导入Prysm
sudo mkdir -p /var/lib/prysm/validator
sudo chown -R wtno:wtno /var/lib/prysm/validator

/usr/local/bin/validator accounts import --keys-dir=$HOME/staking_deposit-cli-d7b5304-linux-amd64/validator_keys --wallet-dir=/var/lib/prysm/validator --goerli
```

接下来按照教程创建一个钱包密码，输入验证器密码，导入密钥

<img src="./img/将验证器密钥库文件导入Prysm.PNG">

创建钱包密码文件
```shell
sudo nano /var/lib/prysm/validator/password.txt
```
略过不截图

## 步骤11：配置Beacon节点服务
```shell
sudo mkdir -p /var/lib/prysm/beacon
sudo chown -R prysmbeacon:prysmbeacon /var/lib/prysm/beacon

sudo nano /etc/systemd/system/prysmbeacon.service
```

将以下内容粘贴到文件中。
```shell
[Unit]
Description=Prysm Consensus Client BN (Goerli Test Network)
Wants=network-online.target
After=network-online.target

[Service]
User=prysmbeacon
Group=prysmbeacon
Type=simple
Restart=always
RestartSec=5
ExecStart=/usr/local/bin/beacon-chain \
  --goerli \
  --datadir=/var/lib/prysm/beacon \
  --execution-endpoint=http://127.0.0.1:8551 \
  --jwt-secret=/var/lib/jwtsecret/jwt.hex \
  --suggested-fee-recipient=0x5Bc4d6760C24Eb7939d3D28A380ADd2EAfFc55d5 \
  --enable-debug-rpc-endpoints \
  --grpc-max-msg-size=65568081 \
  --checkpoint-sync-url=https://prater-checkpoint-sync.stakely.io \
  --genesis-beacon-api-url=https://prater-checkpoint-sync.stakely.io \
  --accept-terms-of-use

[Install]
WantedBy=multi-user.target
```

重新加载systemd以反映更改并启动服务。检查状态以确保它正常运行。
```shell
sudo systemctl daemon-reload
sudo systemctl start prysmbeacon
sudo systemctl status prysmbeacon

sudo journalctl -fu prysmbeacon
```

<img src="./img/配置Beacon节点服务.PNG">

## 步骤12：配置验证器服务
```shell
$ sudo useradd --no-create-home --shell /bin/false prysmvalidator
$ sudo chown -R prysmvalidator:prysmvalidator /var/lib/prysm/validator
$ sudo nano /etc/systemd/system/prysmvalidator.service
```

将以下文件粘贴进去
```shell
[Unit]
Description=Prysm Consensus Client VC (Goerli Test Network)
Wants=network-online.target
After=network-online.target
[Service]
User=prysmvalidator
Group=prysmvalidator
Type=simple
Restart=always
RestartSec=5
ExecStart=/usr/local/bin/validator \
  --datadir=/var/lib/prysm/validator \
  --wallet-dir=/var/lib/prysm/validator \
  --wallet-password-file=/var/lib/prysm/validator/password.txt \
  --graffiti="wtnowtno" \
  --accept-terms-of-use
[Install]
WantedBy=multi-user.target
```

继续执行
```shell
sudo systemctl daemon-reload
sudo systemctl start prysmvalidator
sudo systemctl status prysmvalidator

sudo journalctl -fu prysmvalidator

sudo systemctl enable prysmvalidator
```

<img src="./img/配置验证器服务.PNG">

## 步骤12：为验证者提供资金
为了使用廉价的goerli验证器流程，现在必须在创建验证器密钥和存款文件时将提款地址设置为`0x4D496CcC28058B1D74B7a19541663E21154f9c84`。这是我们智能合约的要求，没有其他方法可以绕过此要求。这是为了防止滥用该服务。

执行Goerli验证器存款的最简单方法！每次存款只需0.0001 GoETH。无需验证。

使用`/cheap-goerli-deposit`斜杠命令，并按照机器人的说明进行操作。您需要开始输入斜杠命令，它将显示在您可以使用它的输入框上方。

由于我们现在强制要求提款地址为由我们的机器人控制的地址，您无法从这个过程中获得实质性的利益。

您现在可以使用钱包地址`0xAAE1f5A0903CB37420f625c639F8F3595D798A76`在[这里](https://goerli.launchpad.ethstaker.cc/)上进行2次廉价存款。请确保查看⁠official-links中有关配置您的机器运行Goerli验证器的指南和工具。

在创建验证器密钥和存款文件时，您必须将提款地址设置为0x4D496CcC28058B1D74B7a19541663E21154f9c84，以便使用此过程完成您的存款。这仅适用于此launchpad。在主网上，如果您想使用提款地址，您应该使用您自己控制的地址。

在高燃气费时，执行此存款交易的燃气费用可能超过实际廉价存款费用0.0001 Goerli ETH。如果您遇到这种情况，您可以尝试从https://faucetlink.to/goerli获取更多的Goerli ETH，或者等待燃气费降低（请参阅https://goerli.beaconcha.in/gasnow以监控Goerli上的燃气费用），或者您可以使用自定义的低燃气费广播您的交易，并等待网络接收该交易。





